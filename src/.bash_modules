#!/bin/bash

# Loading modules from INITIALIZED_MODULES array (defined in `.bashrc` file)
if [[ ! -z ${INITIALIZED_MODULES} ]]; then
    echo
    echo "Adding modules..."

    for module in ${INITIALIZED_MODULES[@]}; do
        module_command_output=$((module add ${module}) 2>&1)

        echo -n "adding \`${module}\`... "
        if [[ -z ${module_command_output} ]]; then
            echo -e "\033[0;32mok\033[0m"
        else
            echo -e "\033[0;31mnok!\033[0m (error: ${module_command_output})"
        fi
    done
fi

# Base conda environment with some useful packages
enable_conda_base() {
    if ! command -v conda &> /dev/null; then
        echo "Enable `conda-modules` module first!"
        return 1
    fi

    BASE_CONDA_ENV_PYTHON="3.9"
    BASE_CONDA_ENV_NAME="base-${BASE_CONDA_ENV_PYTHON}"

    echo "Activating conda env ${BASE_CONDA_ENV_NAME}..."

    base_conda_env_exitsts=$(conda env list -q | grep $BASE_CONDA_ENV_NAME | wc -l)
    if [[ $base_conda_env_exitsts -ne 1 ]]; then
        echo "Conda env ${BASE_CONDA_ENV_NAME} does not exists... creating now!"

        conda create \
            --name $BASE_CONDA_ENV_NAME \
            --no-default-packages \
            python=$BASE_CONDA_ENV_PYTHON

        conda activate $BASE_CONDA_ENV_NAME

        # Install some evergreen packages
        pip install git+https://github.com/fpartl/metarunner.git
        pip install funkybob
        pip install tqdm
        pip install numpy
        pip install xmltodict
        pip install plotly
        pip install pandas
        pip install kaleido
    else
        conda activate $BASE_CONDA_ENV_NAME
    fi
}
